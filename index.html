 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal PAU - Calculadora Matem√°ticas (Formato Corregido)</title>
    
    <!-- MathJax para notaci√≥n matem√°tica -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 1.2em; }
        
        /* --- INDICADORES DE IA --- */
        .ai-status { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .ai-chip { padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 600; border: 2px solid; }
        .ai-deepseek { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .ai-mistral { background: #fff3e0; border-color: #ff9800; color: #e65100; }
        .ai-kimi { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }

        /* --- LAYOUT PRINCIPAL --- */
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .input-section, .results-section { background: #f8f9fa; padding: 25px; border-radius: 20px; border-left: 5px solid #667eea; }
        .results-section { border-left-color: #28a745; }
        .section-title { font-size: 1.4em; font-weight: 600; color: #333; margin-bottom: 20px; }
        
        /* --- FORMULARIO Y BOTONES --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1.1em; transition: all 0.3s ease; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .operation-type { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .operation-btn { padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; text-align: center; font-weight: 600; user-select: none; }
        .operation-btn:hover { border-color: #667eea; background: #f0f4ff; }
        .operation-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .difficulty-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .difficulty-btn { flex: 1; padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9em; user-select: none; }
        .difficulty-btn:hover { border-color: #4caf50; background: #f0fff0; }
        .difficulty-btn.active { background: #4caf50; color: white; border-color: #4caf50; }
        .calculate-btn { width: 100%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
        .calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
        .calculate-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* --- RESULTADOS Y ANIMACIONES --- */
        .loading { display: none; justify-content: center; align-items: center; gap: 10px; color: #666; }
        .spinner { width: 20px; height: 20px; border: 2px solid #e1e5e9; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .result-container { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e1e5e9; animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .result-title { font-weight: 600; color: #333; }
        .ai-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .result-content { font-family: 'Courier New', monospace; font-size: 1.1em; color: #2c3e50; line-height: 1.6; }
        .steps-container { background: #f0f7ff; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .step { margin: 8px 0; padding-left: 20px; position: relative; transition: all 0.3s ease; border-left: 3px solid transparent; }
        .step::before { content: "‚Üí"; position: absolute; left: 0; color: #667eea; font-weight: bold; }
        .step:hover { border-left-color: #667eea; background: rgba(102, 126, 234, 0.05); border-radius: 5px; }
        .typing::after { content: '|'; animation: blink 1s infinite; color: #667eea; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .MathJax { font-size: 1.1em !important; }
        .error-message { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336; }
        
        /* --- SECCI√ìN DE EJEMPLOS --- */
        .examples { margin-top: 30px; padding: 20px; background: #e8f4f8; border-radius: 15px; }
        .example-item { margin: 8px 0; font-family: 'Courier New', monospace; color: #555; cursor: pointer; padding: 10px; border-radius: 5px; transition: background 0.2s; user-select: none; }
        .example-item:hover { background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .container { padding: 20px; }
            h1 { font-size: 2em; }
            .result-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Portal PAU - Calculadora</h1>
        <p class="subtitle">Derivadas e Integrales con IA H√≠brida</p>
        
        <div class="ai-status">
            <div class="ai-chip ai-deepseek">üî¨ DeepSeek V3</div>
            <div class="ai-chip ai-mistral">üéì Mistral Large</div>
            <div class="ai-chip ai-kimi">üåô Kimi K2</div>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">üìù Entrada</h2>

                <div class="form-group">
                    <label for="funcion">Funci√≥n matem√°tica:</label>
                    <input type="text" id="funcion" placeholder="ej: x^2*sin(x) + 3*x - ln(x)" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>Tipo de operaci√≥n:</label>
                    <div class="operation-type">
                        <div class="operation-btn active" data-operacion="derivada">üìà Derivada</div>
                        <div class="operation-btn" data-operacion="integral">‚à´ Integral</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Nivel de explicaci√≥n:</label>
                    <div class="difficulty-selector">
                        <div class="difficulty-btn" data-nivel="rapido">R√°pido</div>
                        <div class="difficulty-btn active" data-nivel="normal">Normal</div>
                        <div class="difficulty-btn" data-nivel="detallado">Detallado</div>
                    </div>
                </div>

                <button class="calculate-btn" id="calculate-btn">
                    <span id="btn-text">üöÄ Resolver</span>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        Procesando...
                    </div>
                </button>
            </div>

            <div class="results-section">
                <h2 class="section-title">‚ú® Resultados</h2>
                <div id="results-container">
                    <div class="result-item">
                        <div class="result-header">
                            <span class="result-title">üí° Esperando entrada...</span>
                        </div>
                        <div class="result-content">
                            Ingresa una funci√≥n y selecciona la operaci√≥n para comenzar.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="examples">
            <h3>üí° Ejemplos para probar:</h3>
            <div class="example-item" data-funcion="x^2" data-operacion="derivada">üìà x¬≤ ‚Üí Derivada b√°sica</div>
            <div class="example-item" data-funcion="x*sin(x)" data-operacion="integral">‚à´ x¬∑sin(x) ‚Üí Integral por partes</div>
            <div class="example-item" data-funcion="sin(x^2)" data-operacion="derivada">üìà sin(x¬≤) ‚Üí Regla de la cadena</div>
            <div class="example-item" data-funcion="x*ln(x)" data-operacion="integral">‚à´ x¬∑ln(x) ‚Üí Integral por partes</div>
            <div class="example-item" data-funcion="e^(2*x)" data-operacion="derivada">üìà e^(2x) ‚Üí Funci√≥n exponencial</div>
            <div class="example-item" data-funcion="x^3 + 2*x^2 - 5*x + 1" data-operacion="derivada">üìà Polinomio completo</div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN E INICIALIZACI√ìN ---
        const backendUrl = 'https://calculadora-pau.vercel.app/api';
        let currentOperation = 'derivada';
        let currentLevel = 'normal';

        // --- FUNCIONES DE L√ìGICA PRINCIPAL ---

        function cambiarOperacion(operacion, elemento) {
            document.querySelectorAll('.operation-btn').forEach(btn => btn.classList.remove('active'));
            elemento.classList.add('active');
            currentOperation = operacion;
        }

        function cambiarNivel(nivel, elemento) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            elemento.classList.add('active');
            currentLevel = nivel;
        }

        function setExample(funcion, operacion) {
            document.getElementById('funcion').value = funcion;
            document.querySelectorAll('.operation-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.operacion === operacion);
            });
            currentOperation = operacion;
        }

        async function resolverProblema() {
            const funcionInput = document.getElementById('funcion');
            const btn = document.getElementById('calculate-btn');
            const btnText = document.getElementById('btn-text');
            const loading = document.getElementById('loading');
            
            const funcion = funcionInput.value.trim();
            if (!funcion) {
                mostrarError('Por favor, ingresa una funci√≥n matem√°tica.');
                return;
            }

            btnText.style.display = 'none';
            loading.style.display = 'flex';
            btn.disabled = true;

            try {
                const operacionTexto = currentOperation === 'derivada' ? 'la derivada' : 'la integral indefinida';
                const prompt = `Calcula ${operacionTexto} de la funci√≥n: ${funcion}`;
                
                let resultados = [];

                if (currentLevel !== 'rapido') {
                    try {
                        const deepseekResult = await llamarAPI('deepseek', { prompt });
                        if (deepseekResult.success) {
                            resultados.push({ titulo: 'üî¨ C√°lculo Principal', modelo: 'DeepSeek V3', content: deepseekResult.resultado, meta: `${deepseekResult.tokens} tokens` });
                        }
                    } catch (error) {
                        console.error('Error DeepSeek:', error);
                        resultados.push({ titulo: 'üî¨ C√°lculo (Fallback)', modelo: 'Sistema Local', content: obtenerResultadoBasico(funcion, currentOperation), meta: 'C√°lculo local' });
                    }
                }

                if (currentLevel === 'normal' || currentLevel === 'detallado') {
                    try {
                        const resultadoPrevio = resultados[0]?.content || 'resultado calculado';
                        const mistralResult = await llamarAPI('mistral', { prompt, resultado: resultadoPrevio });
                        if (mistralResult.success) {
                            resultados.push({ titulo: 'üéì Explicaci√≥n Paso a Paso', modelo: 'Mistral Large', content: mistralResult.explicacion, meta: `${mistralResult.tokens} tokens`, isSteps: true });
                        }
                    } catch (error) {
                        console.error('Error Mistral:', error);
                    }
                }

                if (currentLevel === 'detallado') {
                    try {
                        const kimiResult = await llamarAPI('kimi', { prompt });
                        if (kimiResult.success) {
                            resultados.push({ titulo: 'üåô An√°lisis Contextual', modelo: 'Kimi K2', content: kimiResult.analisis, meta: `${kimiResult.tokens} tokens`, isAnalysis: true });
                        }
                    } catch (error) {
                        console.error('Error Kimi:', error);
                    }
                }

                if (resultados.length === 0) {
                    resultados.push({ titulo: '‚ö° Resultado R√°pido', modelo: 'Sistema Local', content: obtenerResultadoBasico(funcion, currentOperation), meta: 'C√°lculo instant√°neo' });
                }

                mostrarResultados(resultados, funcion);

            } catch (error) {
                mostrarError(`Se produjo un error al contactar con el servidor. Por favor, int√©ntalo de nuevo.`);
                console.error('Error general en resolverProblema:', error);
            } finally {
                btnText.style.display = 'inline';
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        // --- FUNCIONES AUXILIARES Y DE RENDERIZADO ---

        async function llamarAPI(endpoint, data) {
            const response = await fetch(`${backendUrl}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(`Error en la respuesta de la API ${endpoint}: ${response.statusText}`);
            return await response.json();
        }

        function mostrarResultados(resultados, funcionOriginal) {
            const container = document.getElementById('results-container');
            container.innerHTML = `
                <div class="result-item">
                    <div class="result-header">
                        <span class="result-title">üìã Problema: ${currentOperation} de ${convertirNotacionMatematica(funcionOriginal)}</span>
                    </div>
                </div>
            `;
            if (window.MathJax) MathJax.typesetPromise([container]);

            resultados.forEach((resultado, index) => {
                setTimeout(() => mostrarResultadoConEfecto(resultado, container), index * 1500);
            });
        }

        async function mostrarResultadoConEfecto(resultado, container) {
            const badgeClass = resultado.modelo.includes('DeepSeek') ? 'ai-deepseek' : 
                             resultado.modelo.includes('Mistral') ? 'ai-mistral' : 'ai-kimi';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-item';
            resultDiv.style.opacity = '0';
            resultDiv.innerHTML = `
                <div class="result-header">
                    <span class="result-title">${resultado.titulo}</span>
                    <div>
                        <span class="ai-badge ${badgeClass}">${resultado.modelo}</span>
                        <small style="margin-left: 10px; color: #666;">${resultado.meta}</small>
                    </div>
                </div>
            `;
            container.appendChild(resultDiv);
            
            resultDiv.style.transition = 'opacity 0.5s ease';
            requestAnimationFrame(() => { resultDiv.style.opacity = '1'; });

            const contentDiv = document.createElement('div');
            resultDiv.appendChild(contentDiv);

            if (resultado.isSteps) {
                contentDiv.className = 'steps-container';
                const pasos = procesarExplicacion(resultado.content);
                for (const paso of pasos) {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    contentDiv.appendChild(stepDiv);
                    const pasoHtml = convertirFormatoAIaHTML(paso);
                    await escribirTextoHTML(stepDiv, convertirNotacionMatematica(pasoHtml), 30);
                }
            } else if (resultado.isAnalysis) {
                contentDiv.className = 'result-content';
                const analisisLimpio = limpiarAnalisis(resultado.content);
                const analisisTexto = `
                    <strong>Dificultad:</strong> ${analisisLimpio.dificultad}<br>
                    <strong>M√©todos:</strong> ${analisisLimpio.metodos.join(', ')}<br>
                    <strong>Errores comunes:</strong> ${analisisLimpio.errores_comunes.join(', ')}<br>
                    <strong>Consejos PAU:</strong> ${analisisLimpio.consejos_pau?.join(', ') || 'N/A'}
                `;
                await escribirTextoHTML(contentDiv, analisisTexto, 20);
            } else {
                contentDiv.className = 'result-content';
                const contenidoHtml = convertirFormatoAIaHTML(resultado.content);
                await escribirTextoHTML(contentDiv, convertirNotacionMatematica(contenidoHtml), 40);
            }

            if (window.MathJax) MathJax.typesetPromise([contentDiv]);
        }

        async function escribirTextoHTML(elemento, htmlTexto, velocidad) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlTexto;
            const textoPlano = tempDiv.textContent || tempDiv.innerText || '';
            
            elemento.classList.add('typing');
            elemento.innerHTML = ''; // Empezar vac√≠o
            for (let i = 0; i < textoPlano.length; i++) {
                elemento.textContent += textoPlano[i];
                await new Promise(resolve => setTimeout(resolve, velocidad));
            }
            elemento.classList.remove('typing');
            elemento.innerHTML = htmlTexto;
        }

        function mostrarError(mensaje) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<div class="error-message"><strong>‚ö†Ô∏è Error:</strong> ${mensaje}</div>`;
        }

        function procesarExplicacion(texto) {
            return texto.split(/\n+/).filter(linea => linea.trim());
        }

        /**
         * NUEVA FUNCI√ìN: Convierte el formato de la IA a HTML est√°ndar.
         */
        function convertirFormatoAIaHTML(texto) {
            if (typeof texto !== 'string') return texto;
            // Convierte ### T√≠tulo ### a <strong>T√≠tulo</strong>
            let html = texto.replace(/### (.*?) ###/g, '<strong>$1</strong>');
            // Convierte \cdot \cdot texto \cdot \cdot a <strong>texto</strong>
            html = html.replace(/\\cdot \\cdot (.*?) \\cdot \\cdot/g, '<strong>$1</strong>');
            // Elimina \cdot \cdot sueltos que puedan quedar
            html = html.replace(/\\cdot \\cdot/g, '');
            // Convierte saltos de l√≠nea a <br> para que se muestren en HTML
            html = html.replace(/\n/g, '<br>');
            return html.trim();
        }
        
        /**
         * Limpia el objeto de an√°lisis recursivamente.
         */
        function limpiarAnalisis(analisisObj) {
            const limpio = {};
            for (const key in analisisObj) {
                const value = analisisObj[key];
                if (typeof value === 'string') {
                    limpio[key] = convertirFormatoAIaHTML(value);
                } else if (Array.isArray(value)) {
                    limpio[key] = value.map(item => convertirFormatoAIaHTML(item));
                } else {
                    limpio[key] = value;
                }
            }
            return limpio;
        }

        function convertirNotacionMatematica(texto) {
            if (!texto) return '';
            // Solo una regla simple para no interferir con el HTML
            return texto.replace(/\*/g, ' \\cdot ');
        }

        function obtenerResultadoBasico(funcion, operacion) {
            const resultados = {
                'x^2': { derivada: '2x', integral: 'x^3/3 + C' },
                'x*sin(x)': { derivada: 'sin(x) + x*cos(x)', integral: '-x*cos(x) + sin(x) + C' },
                'sin(x^2)': { derivada: '2x*cos(x^2)', integral: 'Integral de Fresnel [no elemental]' },
                'x*ln(x)': { derivada: 'ln(x) + 1', integral: '(x^2/2)*ln(x) - x^2/4 + C' },
                'e^(2*x)': { derivada: '2*e^(2*x)', integral: 'e^(2*x)/2 + C' },
            };
            const resultado = resultados[funcion];
            if (resultado) {
                return operacion === 'derivada' ? resultado.derivada : resultado.integral;
            } else {
                return operacion === 'derivada' ? `f'(x) = [Derivada de ${funcion}]` : `‚à´${funcion} dx = [Integral de ${funcion}] + C`;
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            const funcionInput = document.getElementById('funcion');
            
            document.querySelectorAll('.operation-btn').forEach(btn => {
                btn.addEventListener('click', () => cambiarOperacion(btn.dataset.operacion, btn));
            });

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => cambiarNivel(btn.dataset.nivel, btn));
            });

            document.getElementById('calculate-btn').addEventListener('click', resolverProblema);

            document.querySelectorAll('.example-item').forEach(item => {
                item.addEventListener('click', () => setExample(item.dataset.funcion, item.dataset.operacion));
            });

            funcionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    resolverProblema();
                }
            });

            funcionInput.addEventListener('input', () => {
                if (funcionInput.value === '') {
                    document.getElementById('results-container').innerHTML = `
                        <div class="result-item">
                            <div class="result-header"><span class="result-title">üí° Esperando entrada...</span></div>
                            <div class="result-content">Ingresa una funci√≥n y selecciona la operaci√≥n para comenzar.</div>
                        </div>`;
                }
            });
        });
    </script>
</body>
</html>
